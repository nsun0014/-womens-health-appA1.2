<template>
  <div id="app">
    <AccessibilityHelper />

    <a href="#main-content" class="skip-link">Skip to main content</a>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary" role="navigation" aria-label="Main navigation">
      <div class="container">
        <a class="navbar-brand" href="#" @click.prevent="navigateTo('dashboard')" aria-label="WomenCare home">
          <i class="fas fa-heart me-2" aria-hidden="true"></i>WomenCare
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation menu"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item" v-if="currentUser">
              
                class="nav-link"
                :class="{ active: currentPage === 'dashboard' }"
                href="#"
                @click.prevent="navigateTo('dashboard')"
                :aria-current="currentPage === 'dashboard' ? 'page' : undefined"
              >
                <i class="fas fa-tachometer-alt me-1" aria-hidden="true"></i>Dashboard
              </a>
            </li>

            <li class="nav-item" v-if="currentUser">
              
                class="nav-link"
                :class="{ active: currentPage === 'profile' }"
                href="#"
                @click.prevent="navigateTo('profile')"
                :aria-current="currentPage === 'profile' ? 'page' : undefined"
              >
                <i class="fas fa-user me-1" aria-hidden="true"></i>Health Profile
              </a>
            </li>

            <li class="nav-item" v-if="currentUser">
              
                class="nav-link"
                :class="{ active: currentPage === 'rating' }"
                href="#"
                @click.prevent="navigateTo('rating')"
                :aria-current="currentPage === 'rating' ? 'page' : undefined"
              >
                <i class="fas fa-star me-1" aria-hidden="true"></i>Rate Platform
              </a>
            </li>

            <li class="nav-item" v-if="currentUser">
              
                class="nav-link"
                :class="{ active: currentPage === 'email' }"
                href="#"
                @click.prevent="navigateTo('email')"
                :aria-current="currentPage === 'email' ? 'page' : undefined"
              >
                <i class="fas fa-envelope me-1" aria-hidden="true"></i>Send Email
              </a>
            </li>
            <li class="nav-item" v-if="currentUser">
              
                class="nav-link"
                :class="{ active: currentPage === 'reports' }"
                href="#"
                @click.prevent="navigateTo('reports')"
                :aria-current="currentPage === 'reports' ? 'page' : undefined"
              >
                <i class="fas fa-chart-line me-1" aria-hidden="true"></i>My Reports
              </a>
            </li>

            <li class="nav-item" v-if="currentUser">
              
                class="nav-link"
                :class="{ active: currentPage === 'tables' }"
                href="#"
                @click.prevent="navigateTo('tables')"
                :aria-current="currentPage === 'tables' ? 'page' : undefined"
              >
                <i class="fas fa-table me-1" aria-hidden="true"></i>Data Tables
              </a>
            </li>

            <li class="nav-item" v-if="currentUser">
              
                class="nav-link"
                :class="{ active: currentPage === 'map' }"
                href="#"
                @click.prevent="navigateTo('map')"
                :aria-current="currentPage === 'map' ? 'page' : undefined"
              >
                <i class="fas fa-map-marked-alt me-1" aria-hidden="true"></i>Find Clinics
              </a>
            </li>

            <li class="nav-item" v-if="isAdmin">
              
                class="nav-link"
                :class="{ active: currentPage === 'admin' }"
                href="#"
                @click.prevent="navigateTo('admin')"
                :aria-current="currentPage === 'admin' ? 'page' : undefined"
              >
                <i class="fas fa-cog me-1" aria-hidden="true"></i>Admin Panel
              </a>
            </li>

            <li class="nav-item" v-if="isAdmin">
              
                class="nav-link"
                :class="{ active: currentPage === 'userManagement' }"
                href="#"
                @click.prevent="navigateTo('userManagement')"
                :aria-current="currentPage === 'userManagement' ? 'page' : undefined"
              >
                <i class="fas fa-users-cog me-1" aria-hidden="true"></i>User Management
              </a>
            </li>
          </ul>

          <ul class="navbar-nav">
            <li class="nav-item" v-if="!currentUser">
              <a class="nav-link" href="#" @click.prevent="navigateTo('auth')">
                <i class="fas fa-sign-in-alt me-1" aria-hidden="true"></i>Login / Register
              </a>
            </li>

            <li class="nav-item" v-if="currentUser">
              <span class="nav-link">
                <i class="fas fa-user-circle me-1" aria-hidden="true"></i>
                {{ currentUser.name }}
                <span class="badge ms-1" :class="getUserRoleBadgeClass(currentUser.role)">
                  {{ getUserRoleDisplay(currentUser.role) }}
                </span>
              </span>
            </li>
            <li class="nav-item" v-if="currentUser">
              <a class="nav-link" href="#" @click.prevent="logout" aria-label="Logout">
                <i class="fas fa-sign-out-alt me-1" aria-hidden="true"></i>Logout
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div v-if="accessDenied" class="alert alert-warning alert-dismissible fade show" role="alert" aria-live="polite">
      <div class="container">
        <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>
        <strong>Access Denied:</strong> {{ accessDeniedMessage }}
        <button type="button" class="btn-close" @click="accessDenied = false" aria-label="Close alert"></button>
      </div>
    </div>

    <main id="main-content" role="main" tabindex="-1">
      <AuthSystem
        v-if="currentPage === 'auth' && !currentUser"
        @login-success="handleLoginSuccess"
      />
      <EmailForm v-if="currentPage === 'email' && currentUser" />
      <DataTables v-if="currentPage === 'tables' && currentUser" />
      <MapLocation v-if="currentPage === 'map' && currentUser" />

      <div v-if="currentPage === 'dashboard' && currentUser" class="container mt-4">
        <div class="row">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div>
                <h1>Welcome to Your Dashboard, {{ currentUser.name }}!</h1>
                <p class="text-muted mb-0">
                  You are logged in as:
                  <span class="badge ms-1" :class="getUserRoleBadgeClass(currentUser.role)">
                    {{ getUserRoleDisplay(currentUser.role) }}
                  </span>
                </p>
              </div>
              <div class="role-permissions-info">
                <div class="card border-info">
                  <div class="card-body p-3">
                    <h2 class="card-title mb-2 h6">
                      <i class="fas fa-info-circle me-1" aria-hidden="true"></i>Your Permissions
                    </h2>
                    <ul class="list-unstyled mb-0 small">
                      <li
                        v-for="permission in getUserPermissions(currentUser.role)"
                        :key="permission"
                      >
                        <i class="fas fa-check text-success me-1" aria-hidden="true"></i>{{ permission }}
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div v-if="currentUser.role === 'user'" class="col-12">
            <div class="row">
              <div class="col-md-4 mb-3">
                <div class="card bg-primary text-white">
                  <div class="card-body text-center">
                    <i class="fas fa-file-medical fa-2x mb-2" aria-hidden="true"></i>
                    <h3 class="h4">{{ userStats.profilesCreated }}</h3>
                    <p class="mb-0">Health Profiles</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card bg-success text-white">
                  <div class="card-body text-center">
                    <i class="fas fa-star fa-2x mb-2" aria-hidden="true"></i>
                    <h3 class="h4">{{ userStats.ratingsGiven }}</h3>
                    <p class="mb-0">Ratings Given</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card bg-info text-white">
                  <div class="card-body text-center">
                    <i class="fas fa-calendar fa-2x mb-2" aria-hidden="true"></i>
                    <h3 class="h4">{{ userStats.daysSinceJoined }}</h3>
                    <p class="mb-0">Days Since Joined</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h2 class="h5"><i class="fas fa-bolt me-2" aria-hidden="true"></i>Quick Actions</h2>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <button
                      class="btn btn-outline-primary btn-sm w-100"
                      @click="navigateTo('profile')"
                    >
                      <i class="fas fa-user-edit me-1" aria-hidden="true"></i>Update Health Profile
                    </button>
                  </div>
                  <div class="col-md-6 mb-2">
                    <button
                      class="btn btn-outline-success btn-sm w-100"
                      @click="navigateTo('rating')"
                    >
                      <i class="fas fa-star me-1" aria-hidden="true"></i>Rate Platform
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div v-if="currentUser.role === 'admin'" class="col-12">
            <div class="row">
              <div class="col-md-3 mb-3">
                <div class="card bg-primary text-white">
                  <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-2" aria-hidden="true"></i>
                    <h3 class="h4">{{ adminStats.totalUsers }}</h3>
                    <p class="mb-0">Total Users</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="card bg-success text-white">
                  <div class="card-body text-center">
                    <i class="fas fa-file-medical fa-2x mb-2" aria-hidden="true"></i>
                    <h3 class="h4">{{ adminStats.totalProfiles }}</h3>
                    <p class="mb-0">Health Profiles</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="card bg-warning text-white">
                  <div class="card-body text-center">
                    <i class="fas fa-star fa-2x mb-2" aria-hidden="true"></i>
                    <h3 class="h4">{{ adminStats.averageRating.toFixed(1) }}</h3>
                    <p class="mb-0">Average Rating</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="card bg-info text-white">
                  <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x mb-2" aria-hidden="true"></i>
                    <h3 class="h4">{{ adminStats.totalRatings }}</h3>
                    <p class="mb-0">Total Ratings</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h2 class="h5"><i class="fas fa-tools me-2" aria-hidden="true"></i>Admin Quick Actions</h2>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4 mb-2">
                    <button
                      class="btn btn-outline-primary btn-sm w-100"
                      @click="navigateTo('userManagement')"
                    >
                      <i class="fas fa-users-cog me-1" aria-hidden="true"></i>Manage Users
                    </button>
                  </div>
                  <div class="col-md-4 mb-2">
                    <button
                      class="btn btn-outline-success btn-sm w-100"
                      @click="navigateTo('admin')"
                    >
                      <i class="fas fa-cog me-1" aria-hidden="true"></i>System Settings
                    </button>
                  </div>
                  <div class="col-md-4 mb-2">
                    <button
                      class="btn btn-outline-info btn-sm w-100"
                      @click="navigateTo('reports')"
                    >
                      <i class="fas fa-chart-pie me-1" aria-hidden="true"></i>View Reports
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <Form v-if="currentPage === 'profile' && currentUser" />

      <RatingSystem
        v-if="currentPage === 'rating' && currentUser"
        @rating-updated="handleRatingUpdate"
      />
      <div v-if="currentPage === 'reports' && currentUser" class="container mt-4">
        <h1><i class="fas fa-chart-line me-2" aria-hidden="true"></i>Reports Dashboard</h1>

        <div v-if="currentUser.role === 'user'" class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h2 class="h5">My Personal Health Reports</h2>
              </div>
              <div class="card-body">
                <p class="text-muted mb-3">View and export your personal health data and progress</p>
                
                <div class="row mb-4">
                  <div class="col-md-4">
                    <div class="card bg-light">
                      <div class="card-body text-center">
                        <i class="fas fa-file-medical fa-2x text-primary mb-2" aria-hidden="true"></i>
                        <h3 class="h4">{{ userStats.profilesCreated }}</h3>
                        <p class="mb-0 small">Health Profiles</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card bg-light">
                      <div class="card-body text-center">
                        <i class="fas fa-star fa-2x text-warning mb-2" aria-hidden="true"></i>
                        <h3 class="h4">{{ userStats.ratingsGiven }}</h3>
                        <p class="mb-0 small">Ratings Given</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="card bg-light">
                      <div class="card-body text-center">
                        <i class="fas fa-calendar fa-2x text-info mb-2" aria-hidden="true"></i>
                        <h3 class="h4">{{ userStats.daysSinceJoined }}</h3>
                        <p class="mb-0 small">Days Since Joined</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="alert alert-info" role="status">
                  <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                  Personal reports show your health profile data and rating history.
                </div>

                <div class="d-flex gap-2 flex-wrap">
                  <button 
                    class="btn btn-primary"
                    @click="exportMyReport"
                    aria-label="Export my report as PDF">
                    <i class="fas fa-file-pdf me-2" aria-hidden="true"></i>
                    Export Report (PDF)
                  </button>
                  
                  <button 
                    class="btn btn-outline-primary"
                    @click="exportUserDataCSV"
                    aria-label="Export my data as CSV">
                    <i class="fas fa-file-csv me-2" aria-hidden="true"></i>
                    Export Data (CSV)
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div v-if="currentUser.role === 'admin'" class="row">
          <div class="col-12">
            <div class="card mb-4">
              <div class="card-header">
                <h2 class="h5">System-wide Analytics</h2>
              </div>
              <div class="card-body">
                <p class="text-muted mb-3">Comprehensive platform analytics and user insights</p>
                <div class="row">
                  <div class="col-md-6">
                    <h3 class="h6">User Demographics</h3>
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item d-flex justify-content-between">
                        <span>Regular Users</span>
                        <strong>{{ getRegularUsersCount() }}</strong>
                      </li>
                      <li class="list-group-item d-flex justify-content-between">
                        <span>Admin Users</span>
                        <strong>{{ getAdminUsersCount() }}</strong>
                      </li>
                      <li class="list-group-item d-flex justify-content-between">
                        <span>Active This Month</span>
                        <strong>{{ Math.round(adminStats.totalUsers * 0.8) }}</strong>
                      </li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h3 class="h6">Platform Metrics</h3>
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item d-flex justify-content-between">
                        <span>Health Profiles</span>
                        <strong>{{ adminStats.totalProfiles }}</strong>
                      </li>
                      <li class="list-group-item d-flex justify-content-between">
                        <span>Platform Ratings</span>
                        <strong>{{ adminStats.totalRatings }}</strong>
                      </li>
                      <li class="list-group-item d-flex justify-content-between">
                        <span>Avg. Rating</span>
                        <strong>{{ adminStats.averageRating.toFixed(2) }}</strong>
                      </li>
                    </ul>
                  </div>
                </div>
                
                <div class="mt-4 d-flex gap-2 flex-wrap">
                  <button 
                    class="btn btn-success"
                    @click="exportAdminReport"
                    aria-label="Export full admin report as PDF">
                    <i class="fas fa-file-pdf me-2" aria-hidden="true"></i>
                    Export Full Report (PDF)
                  </button>
                  
                  <button 
                    class="btn btn-outline-success"
                    @click="exportAllUsersCSV"
                    aria-label="Export all users data as CSV">
                    <i class="fas fa-users me-2" aria-hidden="true"></i>
                    Export Users (CSV)
                  </button>
                  
                  <button 
                    class="btn btn-outline-info"
                    @click="exportRatingsCSV"
                    aria-label="Export ratings data as CSV">
                    <i class="fas fa-star me-2" aria-hidden="true"></i>
                    Export Ratings (CSV)
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-if="currentPage === 'admin' && isAdmin" class="container mt-4">
        <h1><i class="fas fa-cog me-2" aria-hidden="true"></i>Admin Panel</h1>

        <div class="card mb-4">
          <div class="card-header">
            <h2 class="h5">System Overview</h2>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h3 class="h6">Platform Statistics</h3>
                <table class="table table-sm">
                  <tbody>
                    <tr>
                      <td>Total Users:</td>
                      <td>
                        <strong>{{ adminStats.totalUsers }}</strong>
                      </td>
                    </tr>
                    <tr>
                      <td>Regular Users:</td>
                      <td>
                        <strong>{{ getRegularUsersCount() }}</strong>
                      </td>
                    </tr>
                    <tr>
                      <td>Admin Users:</td>
                      <td>
                        <strong>{{ getAdminUsersCount() }}</strong>
                      </td>
                    </tr>
                    <tr>
                      <td>Health Profiles:</td>
                      <td>
                        <strong>{{ adminStats.totalProfiles }}</strong>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="col-md-6">
                <h3 class="h6">Recent Activity</h3>
                <div class="list-group list-group-flush">
                  <div class="list-group-item">
                    <i class="fas fa-user-plus text-success me-2" aria-hidden="true"></i>
                    New user registration
                    <small class="text-muted d-block">2 hours ago</small>
                  </div>
                  <div class="list-group-item">
                    <i class="fas fa-star text-warning me-2" aria-hidden="true"></i>
                    Platform rating submitted
                    <small class="text-muted d-block">4 hours ago</small>
                  </div>
                  <div class="list-group-item">
                    <i class="fas fa-file-medical text-info me-2" aria-hidden="true"></i>
                    Health profile updated
                    <small class="text-muted d-block">6 hours ago</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div v-if="currentPage === 'userManagement' && isAdmin" class="container mt-4">
        <h1><i class="fas fa-users-cog me-2" aria-hidden="true"></i>User Management</h1>

        <div class="card">
          <div class="card-header">
            <h2 class="h5">All Users</h2>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped" aria-label="User list">
                <thead>
                  <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Email</th>
                    <th scope="col">Role</th>
                    <th scope="col">Registered</th>
                    <th scope="col">Status</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="user in allUsers" :key="user.id">
                    <td>{{ user.name }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                      <span class="badge" :class="getUserRoleBadgeClass(user.role)">
                        {{ getUserRoleDisplay(user.role) }}
                      </span>
                    </td>
                    <td>{{ formatDate(user.createdAt || '2024-01-01') }}</td>
                    <td>
                      <span class="badge bg-success">Active</span>
                    </td>
                    <td>
                      <button
                        class="btn btn-sm btn-outline-primary me-1"
                        :disabled="user.id === currentUser.id"
                        @click="viewUserDetails(user)"
                        :aria-label="`View details for ${user.name}`"
                      >
                        <i class="fas fa-eye" aria-hidden="true"></i>
                      </button>
                      <button
                        class="btn btn-sm btn-outline-warning"
                        :disabled="user.id === currentUser.id"
                        :aria-label="`Edit ${user.name}`"
                      >
                        <i class="fas fa-edit" aria-hidden="true"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div v-if="currentPage !== 'auth' && !currentUser" class="container mt-5">
        <div class="row justify-content-center">
          <div class="col-md-6 text-center">
            <i class="fas fa-lock fa-5x text-muted mb-3" aria-hidden="true"></i>
            <h1 class="h3">Authentication Required</h1>
            <p class="text-muted mb-4">Please log in to access this feature.</p>
            <button class="btn btn-primary" @click="navigateTo('auth')">
              <i class="fas fa-sign-in-alt me-2" aria-hidden="true"></i>Login / Register
            </button>
          </div>
        </div>
      </div>
    </main>

    <footer class="footer bg-dark text-white mt-auto" role="contentinfo">
      <div class="container py-4">
        <div class="row">
          <div class="col-md-6">
            <h2 class="h5"><i class="fas fa-heart me-2" aria-hidden="true"></i>WomenCare</h2>
            <p class="mb-0">Empowering women's health through technology and community support.</p>
          </div>
          <div class="col-md-6 text-md-end">
            <p class="mb-1">Contact: support@womencare.com</p>
            <p class="mb-0">&copy; 2024 WomenCare Platform. All rights reserved.</p>
          </div>
        </div>
      </div>
    </footer>

    <div class="sr-only" role="status" aria-live="polite" aria-atomic="true" ref="announcer">
      {{ liveAnnouncement }}
    </div>
  </div>
</template>
<script>
import Form from './components/Form.vue'
import AuthSystem from './components/AuthSystem.vue'
import RatingSystem from './components/RatingSystem.vue'
import { sanitizeInput, logSecurityEvent } from './utils/security.js'
import EmailForm from './components/EmailForm.vue'
import DataTables from './components/DataTables.vue'
import MapLocation from './components/MapLocation.vue'
import AccessibilityHelper from './components/AccessibilityHelper.vue'
import { exportToCSV, exportToPDF, exportUserReportToPDF, exportAdminReportToPDF } from './utils/exportUtils.js'

export default {
  name: 'App',
  components: {
    Form,
    AuthSystem,
    RatingSystem,
    EmailForm,
    DataTables,
    MapLocation,
    AccessibilityHelper,
  },
  data() {
    return {
      currentPage: 'auth',
      currentUser: null,
      accessDenied: false,
      accessDeniedMessage: '',
      liveAnnouncement: '',
      adminStats: {
        totalUsers: 0,
        totalProfiles: 0,
        averageRating: 0,
        totalRatings: 0,
      },
      userStats: {
        profilesCreated: 0,
        ratingsGiven: 0,
        daysSinceJoined: 0,
      },
      allUsers: [],
      recentRatings: [],
    }
  },
  computed: {
    isAdmin() {
      return this.currentUser && this.currentUser.role === 'admin'
    },
    isUser() {
      return this.currentUser && this.currentUser.role === 'user'
    },
  },
  methods: {
    sanitizeInput(input) {
      return sanitizeInput(input)
    },

    announce(message) {
      this.liveAnnouncement = message
      setTimeout(() => {
        this.liveAnnouncement = ''
      }, 1000)
    },

    navigateTo(page) {
      if (!this.hasAccessToPage(page)) {
        this.showAccessDenied(page)
        return
      }
      this.currentPage = page
      this.accessDenied = false
    },

    hasAccessToPage(page) {
      const publicPages = ['auth']
      if (publicPages.includes(page)) {
        return true
      }
      if (!this.currentUser) {
        return false
      }
      const userPages = ['dashboard', 'profile', 'rating', 'reports', 'email', 'tables', 'map']
      if (userPages.includes(page)) {
        return true
      }
      const adminPages = ['admin', 'userManagement']
      if (adminPages.includes(page)) {
        return this.currentUser.role === 'admin'
      }
      return false
    },

    showAccessDenied(page) {
      this.accessDenied = true
      if (!this.currentUser) {
        this.accessDeniedMessage = 'You must be logged in to access this page.'
      } else if (page === 'admin' || page === 'userManagement') {
        this.accessDeniedMessage = 'This page is restricted to administrators only.'
      } else {
        this.accessDeniedMessage = 'You do not have permission to access this page.'
      }
    },

    getUserRoleDisplay(role) {
      const roleMap = {
        user: 'User',
        admin: 'Administrator',
      }
      return roleMap[role] || role
    },

    getUserRoleBadgeClass(role) {
      const classMap = {
        user: 'bg-primary',
        admin: 'bg-danger',
      }
      return classMap[role] || 'bg-secondary'
    },

    getUserPermissions(role) {
      const permissions = {
        user: [
          'View dashboard',
          'Create health profiles',
          'Rate platform',
          'View personal reports',
          'Send emails',
          'View data tables',
          'Find health clinics',
        ],
        admin: [
          'All user permissions',
          'Manage all users',
          'Access admin panel',
          'View system analytics',
        ],
      }
      return permissions[role] || []
    },

    getRegularUsersCount() {
      return this.allUsers.filter((user) => user.role === 'user').length
    },

    getAdminUsersCount() {
      return this.allUsers.filter((user) => user.role === 'admin').length
    },

    viewUserDetails(user) {
      if (!this.isAdmin) {
        this.showAccessDenied('userManagement')
        return
      }
      alert(
        `User Details:\nName: ${user.name}\nEmail: ${user.email}\nRole: ${this.getUserRoleDisplay(user.role)}\nJoined: ${this.formatDate(user.createdAt || '2024-01-01')}`,
      )
    },
    exportMyReport() {
      if (!this.currentUser) return

      const success = exportUserReportToPDF(this.currentUser, this.userStats)
      
      if (success) {
        this.showMobileNotification('Report exported successfully!')
        logSecurityEvent('USER_REPORT_EXPORTED', {
          userId: this.currentUser.id,
          format: 'PDF'
        })
      }
    },

    exportUserDataCSV() {
      if (!this.currentUser) return

      const userData = [{
        Name: this.currentUser.name,
        Email: this.currentUser.email,
        Role: this.currentUser.role,
        'Profiles Created': this.userStats.profilesCreated,
        'Ratings Given': this.userStats.ratingsGiven,
        'Days Since Joined': this.userStats.daysSinceJoined,
        'Generated Date': new Date().toLocaleString()
      }]

      const success = exportToCSV(userData, `${this.currentUser.name}_Data`)
      
      if (success) {
        this.showMobileNotification('Data exported as CSV!')
        logSecurityEvent('USER_DATA_EXPORTED', {
          userId: this.currentUser.id,
          format: 'CSV'
        })
      }
    },

    exportAdminReport() {
      if (!this.isAdmin) return

      const success = exportAdminReportToPDF(this.adminStats, this.allUsers)
      
      if (success) {
        this.showMobileNotification('Admin report exported successfully!')
        logSecurityEvent('ADMIN_REPORT_EXPORTED', {
          userId: this.currentUser.id,
          totalUsers: this.adminStats.totalUsers
        })
      }
    },

    exportAllUsersCSV() {
      if (!this.isAdmin) return

      const usersData = this.allUsers.map(user => ({
        Name: user.name,
        Email: user.email,
        Role: user.role,
        'Registered Date': user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A',
        Status: 'Active'
      }))

      const success = exportToCSV(usersData, 'All_Users_Data')
      
      if (success) {
        this.showMobileNotification('User data exported as CSV!')
        logSecurityEvent('ALL_USERS_EXPORTED', {
          adminId: this.currentUser.id,
          userCount: usersData.length,
          format: 'CSV'
        })
      }
    },

    exportRatingsCSV() {
      const ratings = JSON.parse(localStorage.getItem('platformRatings') || '[]')
      
      if (ratings.length === 0) {
        alert('No ratings data to export')
        return
      }

      const ratingsData = ratings.map(rating => ({
        User: rating.userName,
        Score: rating.score,
        Comment: rating.comment || 'No comment',
        Date: new Date(rating.date).toLocaleString()
      }))

      const success = exportToCSV(ratingsData, 'Platform_Ratings')
      
      if (success) {
        this.showMobileNotification('Ratings exported as CSV!')
        logSecurityEvent('RATINGS_EXPORTED', {
          userId: this.currentUser?.id,
          count: ratingsData.length
        })
      }
    },
    handleLoginSuccess(user) {
      this.currentUser = {
        ...user,
        name: this.sanitizeInput(user.name),
        email: this.sanitizeInput(user.email),
      }
      this.currentPage = 'dashboard'
      this.loadPlatformData()
      this.loadUserStats()

      logSecurityEvent('USER_SESSION_START', {
        userId: user.id,
        userRole: user.role,
      })
    },

    handleRatingUpdate(newRating) {
      const sanitizedRating = {
        ...newRating,
        userName: this.sanitizeInput(newRating.userName),
        comment: this.sanitizeInput(newRating.comment),
      }

      this.loadPlatformData()
      this.loadUserStats()
      this.showMobileNotification('Rating submitted successfully!')

      logSecurityEvent('RATING_SUBMITTED', {
        userId: this.currentUser?.id,
        ratingScore: sanitizedRating.score,
      })
    },

    logout() {
      logSecurityEvent('USER_LOGOUT', {
        userId: this.currentUser?.id,
        userRole: this.currentUser?.role,
        sessionDuration: this.currentUser?.loginTime
          ? Date.now() - new Date(this.currentUser.loginTime).getTime()
          : 0,
      })

      localStorage.removeItem('currentUser')
      this.currentUser = null
      this.currentPage = 'auth'
      this.accessDenied = false
    },

    loadPlatformData() {
      const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]')
      const demoUsers = [
        { id: 1, name: 'Demo User', email: 'user@demo.com', role: 'user', createdAt: '2024-01-01' },
        {
          id: 2,
          name: 'Admin User',
          email: 'admin@demo.com',
          role: 'admin',
          createdAt: '2024-01-01',
        },
      ]
      this.allUsers = [...demoUsers, ...registeredUsers]

      const healthProfiles = JSON.parse(localStorage.getItem('healthProfiles') || '[]')
      const ratings = JSON.parse(localStorage.getItem('platformRatings') || '[]')
      this.recentRatings = ratings.sort((a, b) => new Date(b.date) - new Date(a.date))

      this.adminStats = {
        totalUsers: this.allUsers.length,
        totalProfiles: healthProfiles.length,
        averageRating: ratings.length
          ? ratings.reduce((sum, r) => sum + r.score, 0) / ratings.length
          : 0,
        totalRatings: ratings.length,
      }
    },

    loadUserStats() {
      if (!this.currentUser) return

      const healthProfiles = JSON.parse(localStorage.getItem('healthProfiles') || '[]')
      const ratings = JSON.parse(localStorage.getItem('platformRatings') || '[]')

      const userProfiles = healthProfiles.filter((p) => p.email === this.currentUser.email).length
      const userRatings = ratings.filter((r) => r.userId === this.currentUser.id).length

      const joinDate = this.currentUser.createdAt
        ? new Date(this.currentUser.createdAt)
        : new Date()
      const daysSinceJoined = Math.floor((new Date() - joinDate) / (1000 * 60 * 60 * 24))

      this.userStats = {
        profilesCreated: userProfiles,
        ratingsGiven: userRatings,
        daysSinceJoined: Math.max(1, daysSinceJoined),
      }
    },

    formatDate(dateString) {
      return new Date(dateString).toLocaleDateString()
    },

    showMobileNotification(message) {
      const notification = document.createElement('div')
      notification.className = 'alert alert-success position-fixed'
      notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;'
      notification.innerHTML = `
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        <div><i class="fas fa-check-circle me-2"></i>${message}</div>
      `
      document.body.appendChild(notification)

      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove()
        }
      }, 4000)
    },

    performSecurityChecks() {
      if (window.top !== window.self) {
        logSecurityEvent('CLICKJACKING_ATTEMPT', {
          topOrigin: window.top.location.origin,
          selfOrigin: window.self.location.origin,
        })
        console.warn('Application loaded in iframe - potential clickjacking attempt')
      }

      logSecurityEvent('APP_LOADED', {
        userAgent: navigator.userAgent.substring(0, 100),
        timestamp: new Date().toISOString(),
      })
    },
  },

  mounted() {
    this.performSecurityChecks()

    const savedUser = localStorage.getItem('currentUser')
    if (savedUser) {
      try {
        this.currentUser = JSON.parse(savedUser)
        this.currentPage = 'dashboard'

        logSecurityEvent('USER_SESSION_RESTORED', {
          userId: this.currentUser.id,
          userRole: this.currentUser.role,
        })
      } catch (error) {
        localStorage.removeItem('currentUser')
        logSecurityEvent('SESSION_RESTORE_ERROR', { error: error.message })
      }
    }
    this.loadPlatformData()
    this.loadUserStats()
  },
}
</script>

<style scoped>
.skip-link {
  position: absolute;
  top: -40px;
  left: 0;
  background: #0d6efd;
  color: white;
  padding: 8px 16px;
  text-decoration: none;
  z-index: 10000;
  border-radius: 0 0 4px 0;
}

.skip-link:focus {
  top: 0;
  outline: 3px solid #ffc107;
  outline-offset: 2px;
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

#app {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

main {
  flex: 1;
}

.footer {
  margin-top: auto;
}

.card {
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  border: none;
}

.badge {
  font-size: 0.75em;
}

.role-permissions-info {
  max-width: 300px;
}

.nav-link:hover {
  background-color: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
}

.nav-link.active {
  background-color: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

.alert {
  border: none;
  border-radius: 0;
}

.bg-danger {
  background-color: #dc3545 !important;
}

.bg-primary {
  background-color: #0d6efd !important;
}

.text-muted {
  color: #5a6268 !important;
}

.form-text {
  color: #495057 !important;
}

.btn-outline-primary {
  color: #0a58ca;
  border-color: #0a58ca;
}

.btn-outline-primary:hover {
  background-color: #0a58ca;
  border-color: #0a58ca;
}

.btn-outline-secondary {
  color: #495057;
  border-color: #495057;
}

@media (max-width: 991.98px) {
  .navbar-nav {
    padding: 1rem 0;
  }

  .navbar-nav .nav-item {
    margin: 0.25rem 0;
  }

  .navbar-nav .nav-link {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin: 0.25rem 0;
    transition: background-color 0.3s ease;
  }

  .role-permissions-info {
    max-width: 100%;
    margin-top: 1rem;
  }
}

.btn:disabled {
  opacity: 0.65;
  cursor: not-allowed;
}

.table-hover tbody tr:hover {
  background-color: rgba(0, 0, 0, 0.05);
}
</style>